<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE extension SYSTEM "ext-1.0.dtd">
<!--
/**
 * Blog
 *
 * Allows to add a blog to your S2 site
 *
 * @copyright (C) 2007-2023 Roman Parpalak
 * @license http://www.gnu.org/licenses/gpl.html GPL version 2 or higher
 * @package s2_blog
 */
-->

<extension for="S2" engine="1.0">
	<id>s2_blog</id>
	<title>Blog</title>
	<version>2.0dev</version>
	<description>Adds a blog to your site.</description>
	<author>Roman Parpalak</author>

	<adminaffected>1</adminaffected>

	<minversion>2.0dev</minversion>
	<maxtestedon>2.0dev</maxtestedon>

	<note type="uninstall" timing="pre">Warning! All your posts and user comments will be deleted during the uninstall process. It is strongly recommended you to disable 'Blog' extension instead or to upgrade it without uninstalling.</note>

	<install><![CDATA[
// Setup posts table
if (!$s2_db->table_exists('s2_blog_posts'))
{
	$schema = array(
		'FIELDS'			=> array(
			'id'				=> array(
				'datatype'		=> 'SERIAL',
				'allow_null'	=> false
			),
			'create_time'	=> array(
				'datatype'		=> 'INT(10) UNSIGNED',
				'allow_null'	=> false,
				'default'		=> '0'
			),
			'modify_time'	=> array(
				'datatype'		=> 'INT(10) UNSIGNED',
				'allow_null'	=> false,
				'default'		=> '0'
			),
			'revision'		=> array(
				'datatype'		=> 'INT(10) UNSIGNED',
				'allow_null'	=> false,
				'default'		=> '1'
			),
			'title'			=> array(
				'datatype'		=> 'VARCHAR(255)',
				'allow_null'	=> false,
				'default'		=> '\'\''
			),
			'text'			=> array(
				'datatype'		=> 'LONGTEXT',
				'allow_null'	=> true
			),
			'published'		=> array(
				'datatype'		=> 'TINYINT(1)',
				'allow_null'	=> false,
				'default'		=> '0'
			),
			'favorite'		=> array(
				'datatype'		=> 'TINYINT(1)',
				'allow_null'	=> false,
				'default'		=> '0'
			),
			'commented'		=> array(
				'datatype'		=> 'TINYINT(1)',
				'allow_null'	=> false,
				'default'		=> '1'
			),
			'label'			=> array(
				'datatype'		=> 'VARCHAR(255)',
				'allow_null'	=> false,
				'default'		=> '\'\''
			),
			'url'			=> array(
				'datatype'		=> 'VARCHAR(255)',
				'allow_null'	=> false,
				'default'		=> '\'\''
			),
			'user_id'		=> array(
				'datatype'		=> 'INT(10) UNSIGNED',
				'allow_null'	=> false,
				'default'		=> '0'
			)
		),
		'PRIMARY KEY'	=> array('id'),
		'INDEXES'		=> array(
			'url_idx'					=> array('url'),
			'create_time_idx'			=> array('create_time'),
			'create_time_published_idx'	=> array('create_time', 'published'),
			'id_published_idx'			=> array('id', 'published'),
			'favorite_idx'				=> array('favorite'),
			'label_idx'					=> array('label')
		)
	);

	$s2_db->create_table('s2_blog_posts', $schema);
}
else
{
	$s2_db->add_field('s2_blog_posts', 'revision', 'INT(10) UNSIGNED', false, '1', 'modify_time');
	$s2_db->add_field('s2_blog_posts', 'user_id', 'INT(10) UNSIGNED', false, '0', 'url');
}

// For old installations
$s2_db->add_index('s2_blog_posts', 'create_time_published_idx', array('create_time', 'published'));
$s2_db->add_index('s2_blog_posts', 'id_published_idx', array('id', 'published'));
$s2_db->add_index('s2_blog_posts', 'favorite_idx', array('favorite'));

// Setup blog comments table
if (!$s2_db->table_exists('s2_blog_comments'))
{
	$schema = array(
		'FIELDS'		=> array(
			'id'			=> array(
				'datatype'		=> 'SERIAL',
				'allow_null'	=> false
			),
			'post_id'		=> array(
				'datatype'		=> 'INT(10) UNSIGNED',
				'allow_null'	=> false,
				'default'		=> '0'
			),
			'time'			=> array(
				'datatype'		=> 'INT(10) UNSIGNED',
				'allow_null'	=> false,
				'default'		=> '0'
			),
			'ip'			=> array(
				'datatype'		=> 'VARCHAR(39)',
				'allow_null'	=> false,
				'default'		=> '\'\''
			),
			'nick'			=> array(
				'datatype'		=> 'VARCHAR(50)',
				'allow_null'	=> false,
				'default'		=> '\'\''
			),
			'email'			=> array(
				'datatype'		=> 'VARCHAR(80)',
				'allow_null'	=> false,
				'default'		=> '\'\''
			),
			'show_email'	=> array(
				'datatype'		=> 'TINYINT(1)',
				'allow_null'	=> false,
				'default'		=> '0'
			),
			'subscribed'	=> array(
				'datatype'		=> 'TINYINT(1)',
				'allow_null'	=> false,
				'default'		=> '0'
			),
			'shown'			=> array(
				'datatype'		=> 'TINYINT(1)',
				'allow_null'	=> false,
				'default'		=> '1'
			),
			'sent'			=> array(
				'datatype'		=> 'TINYINT(1)',
				'allow_null'	=> false,
				'default'		=> '1'
			),
			'good'			=> array(
				'datatype'		=> 'TINYINT(1)',
				'allow_null'	=> false,
				'default'		=> '0'
			),
			'text'			=> array(
				'datatype'		=> 'TEXT',
				'allow_null'	=> true
			),
		),
		'PRIMARY KEY'	=> array('id'),
		'INDEXES'		=> array(
			'post_id_idx'	=> array('post_id'),
			'sort_idx'		=> array('post_id', 'time', 'shown'),
			'time_idx'		=> array('time')
		)
	);

	$s2_db->create_table('s2_blog_comments', $schema);
}

// For old installations
$s2_db->add_index('s2_blog_comments', 'sort_idx', array('post_id', 'time', 'shown'));

// Setup table to link posts and tags
if (!$s2_db->table_exists('s2_blog_post_tag'))
{
	$schema = array(
		'FIELDS'		=> array(
			'id'		=> array(
				'datatype'		=> 'SERIAL',
				'allow_null'	=> false
			),
			'post_id'	=> array(
				'datatype'		=> 'INT(10) UNSIGNED',
				'allow_null'	=> false,
				'default'		=> '0'
			),
			'tag_id'	=> array(
				'datatype'		=> 'INT(10) UNSIGNED',
				'allow_null'	=> false,
				'default'		=> '0'
			),
		),
		'PRIMARY KEY'	=> array('id'),
		'INDEXES'		=> array(
			'post_id_idx'		=> array('post_id'),
			'tag_id_idx'		=> array('tag_id'),
		),
	);

	$s2_db->create_table('s2_blog_post_tag', $schema);
}

// Add extension options to the config table
$s2_blog_config = array(
	'S2_BLOG_URL'		=> '/blog',
	'S2_BLOG_TITLE'		=> 'My blog',
);

foreach ($s2_blog_config as $conf_name => $conf_value)
{
	if (defined($conf_name))
		continue;

	$query = array(
		'INSERT'	=> 'name, value',
		'INTO'		=> 'config',
		'VALUES'	=> '\''.$conf_name.'\', \''.$conf_value.'\''
	);

	$s2_db->query_build($query);
}

// User permissions
if ($s2_db->field_exists('users', 'edit_s2_blog'))
	$s2_db->drop_field('users', 'edit_s2_blog');

// A field in tags table for important tags displaying
if (!$s2_db->field_exists('tags', 's2_blog_important'))
	$s2_db->add_field('tags', 's2_blog_important', 'INT(1)', false, '0');

$s2_db->add_index('tags', 's2_blog_important_idx', array('s2_blog_important'));

	]]></install>

	<uninstall><![CDATA[
$query = array(
	'DELETE'	=> 'config',
	'WHERE'		=> 'name in (\'S2_BLOG_URL\', \'S2_BLOG_TITLE\')',
);
$s2_db->query_build($query);

$s2_db->drop_table('s2_blog_posts');
$s2_db->drop_table('s2_blog_post_tag');
$s2_db->drop_table('s2_blog_comments');

$s2_db->drop_field('tags', 's2_blog_important');
	]]></uninstall>

</extension>
