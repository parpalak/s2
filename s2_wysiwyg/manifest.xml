<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE extension SYSTEM "ext-1.0.dtd">
<!--
/**
 * WYSIWYG
 *
 * Adds TinyMCE WYSIWYG editor to the article edit form.
 *
 * @copyright (C) 2007-2012 Roman Parpalak
 * @license http://www.gnu.org/licenses/gpl.html GPL version 2 or higher
 * @package s2_wysiwyg
 */
-->

<extension for="S2" engine="1.0">
	<id>s2_wysiwyg</id>
	<title>WYSIWYG</title>
	<version>1.0b2</version>
	<description>Adds TinyMCE WYSIWYG editor to the admin panel.</description>
	<author>Roman Parpalak</author>

	<minversion>1.0b</minversion>
	<maxtestedon>1.0b2</maxtestedon>

	<install><![CDATA[
$s2_wysiwys_config = array(
	'S2_WYSIWYG_TYPE'		=> '0',
);

foreach ($s2_wysiwys_config as $conf_name => $conf_value)
{
	if (defined($conf_name))
		continue;

	$query = array(
		'INSERT'	=> 'name, value',
		'INTO'		=> 'config',
		'VALUES'	=> '\''.$conf_name.'\', \''.$conf_value.'\''
	);

	$s2_db->query_build($query) or error(__FILE__, __LINE__);
}
	]]></install>

	<uninstall><![CDATA[
$query = array(
	'DELETE'	=> 'config',
	'WHERE'		=> 'name in (\'S2_WYSIWYG_TYPE\')',
);
$s2_db->query_build($query) or error(__FILE__, __LINE__);
	]]></uninstall>

	<hooks>
		<hook id="ai_head_end"><![CDATA[
?>
<script type="text/javascript">
	var s2_wysiwyg_type = <?php echo S2_WYSIWYG_TYPE; ?>;
</script>
<script type="text/javascript" src="<?php echo $ext_info['url']; ?>/tiny_mce/tiny_mce.js"></script>
<script type="text/javascript" src="<?php echo $ext_info['url']; ?>/init.js"></script>
<?php
		]]></hook>

		<hook id="ai_after_js_init"><![CDATA[
?>
var s2_wysiwyg_pict_url = '<?php echo S2_PATH; ?>/_admin/pictman.php';
<?php
		]]></hook>

		<hook id="rq_action_load_pre_output"><![CDATA[
s2_add_js_header('s2_wysiwyg_set_path("'.s2_link(s2_path_from_id($id)).'"); tinyMCE.execCommand("mceRemoveControl", false, "arttext");');
s2_add_js_header_delayed('tinyMCE.execCommand("mceAddControl", false, "arttext");');
		]]></hook>

		<hook id="fn_preload_editor_end, blfn_preload_editor_end"><![CDATA[
echo '<script type="text/javascript">s2_wysiwyg_set_path("'.$_GET['path'].'");</script>';
		]]></hook>

		<hook id="fn_toolbar_start"><![CDATA[
return '<hr />';
		]]></hook>

		<hook id="fn_output_article_form_pre_text,fn_s2_blog_post_form_pre_text"><![CDATA[
$padding -= 2.4;
		]]></hook>

		<hook id="fn_s2_blog_edit_post_form_pre_output"><![CDATA[
if (isset($_GET['action']) && $_GET['action'] == 'edit_blog_post')
{
	s2_add_js_header('s2_wysiwyg_set_path("'.S2_BLOG_PATH.date('Y/m/d/', $page['create_time']).'"); tinyMCE.execCommand("mceRemoveControl", false, "arttext");');
	s2_add_js_header_delayed('tinyMCE.execCommand("mceAddControl", false, "arttext");');
}
		]]></hook>

		<hook id="fn_get_options_pre_comment_fs"><![CDATA[
if (file_exists($ext_info['path'].'/lang/'.S2_LANGUAGE.'.php'))
	require $ext_info['path'].'/lang/'.S2_LANGUAGE.'.php';
else
	require $ext_info['path'].'/lang/English.php';
$fieldset = array(
	'S2_WYSIWYG_TYPE' => s2_get_checkbox('S2_WYSIWYG_TYPE', $options['S2_WYSIWYG_TYPE'], $lang_s2_wysiwyg['WYSIWYG type'], $lang_s2_wysiwyg['WYSIWYG type label']),
);
($hook = s2_hook('s2_wysiwyg_opt_pre_fs_merge')) ? eval($hook) : null;
$output .= '<fieldset><legend>'.$lang_s2_wysiwyg['WYSIWYG'].'</legend>'.implode('', $fieldset).'</fieldset>';
		]]></hook>

		<hook id="opt_start"><![CDATA[
$s2_const_types['S2_WYSIWYG_TYPE'] = 'int';
		]]></hook>

	</hooks>
</extension>
